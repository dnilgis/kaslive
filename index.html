<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASLIVE // TERMINAL V9.0</title>
    <style>
        /* --- IMPORTS & VARS --- */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500;800&display=swap');
        
        :root {
            --hex-green: #00ff41;
            --hex-bright: #ccffcc;
            --hex-dim: #004d1a;
            --hex-alert: #ff3333;
            --hex-warn: #ffcc00;
            --hex-cyan: #00e5ff;
            --hex-blue: #2E86DE; 
            --hex-purple: #bd00ff;
            
            --bg-deep: #020406;
            --panel-bg: rgba(5, 12, 16, 0.85);
            --panel-border: 1px solid rgba(0, 255, 65, 0.2);
            
            --font-main: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            background-color: #000;
            color: var(--hex-green);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- CRT EFFECTS --- */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 3px;
            pointer-events: none;
            z-index: 99;
            opacity: 0.3; 
        }

        /* --- LAYOUT REBALANCED --- */
        .cockpit {
            width: 98vw;
            height: 96vh;
            display: grid;
            grid-template-columns: 280px 1fr 280px; 
            grid-template-rows: 70px 1fr 60px; 
            gap: 12px;
            position: relative;
            z-index: 10;
        }

        /* --- MODULES --- */
        .module {
            background: var(--panel-bg);
            border: var(--panel-border);
            padding: 12px;
            position: relative;
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .module::before { content: ""; position: absolute; top: -1px; left: -1px; width: 8px; height: 8px; border-top: 2px solid var(--hex-green); border-left: 2px solid var(--hex-green); }
        .module::after { content: ""; position: absolute; bottom: -1px; right: -1px; width: 8px; height: 8px; border-bottom: 2px solid var(--hex-green); border-right: 2px solid var(--hex-green); }

        .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--hex-dim);
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.1);
            padding-bottom: 4px;
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            align-items: center;
            position: relative; /* For tooltip positioning */
        }

        /* --- TOOLTIPS --- */
        .tooltip-trigger {
            cursor: help;
            color: var(--hex-cyan);
            font-size: 0.7rem;
            margin-left: 5px;
            opacity: 0.7;
            border-bottom: 1px dotted var(--hex-cyan);
        }
        .tooltip-trigger:hover { opacity: 1; text-shadow: 0 0 5px var(--hex-cyan); }
        
        .tooltip-box {
            display: none;
            position: absolute;
            background: #000;
            border: 1px solid var(--hex-cyan);
            color: #fff;
            padding: 10px;
            font-size: 0.7rem;
            width: 220px;
            z-index: 100;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
            line-height: 1.4;
            pointer-events: none;
            text-transform: none;
            font-weight: normal;
            text-align: left;
        }
        .tooltip-trigger:hover + .tooltip-box { display: block; }

        /* --- HEADER --- */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--hex-dim);
            padding: 0 20px;
        }

        .brand { font-weight: 800; font-size: 1.8rem; letter-spacing: 2px; text-shadow: 0 0 15px rgba(0,255,65,0.2); }
        
        .price-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
        }
        .price-tag { font-size: 1.8rem; font-weight: 500; color: #fff; line-height: 1; }
        .price-tag span { font-size: 1rem; color: var(--hex-green); opacity: 0.8;}
        
        .ath-display {
            font-size: 0.6rem;
            color: var(--hex-dim);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* --- LEFT WING --- */
        .feed-panel { grid-row: 2; overflow: hidden; display: flex; flex-direction: column; }
        
        .token-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column; 
            gap: 6px; 
            scrollbar-width: thin;
            scrollbar-color: var(--hex-dim) black;
            min-height: 0;
        }
        .token-card {
            display: grid;
            grid-template-columns: 1.2fr 1fr 0.8fr;
            align-items: center;
            padding: 6px 8px;
            background: rgba(0,20,0,0.2);
            border: 1px solid transparent;
            font-size: 0.7rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .token-card:hover { border-color: var(--hex-dim); background: rgba(0,255,65,0.05); }
        .tk-name { font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .tk-ticker { font-size: 0.6rem; color: var(--hex-dim); }
        .tk-supply { text-align: right; font-family: monospace; color: #aaa; font-size: 0.65rem; }
        .tk-status { text-align: right; font-weight: bold; font-size: 0.6rem; }
        .status-minting { color: var(--hex-warn); animation: pulse 2s infinite; }
        .status-done { color: var(--hex-blue); }

        .sonar-log {
            flex: 1;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.7rem;
            min-height: 0;
        }
        .sonar-entry {
            padding: 4px 6px;
            border-left: 2px solid transparent;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0.9;
            transition: all 0.3s;
            cursor: pointer;
        }
        .sonar-entry:hover { background: rgba(255,255,255,0.1); }
        .sonar-entry.buy { border-color: var(--hex-green); color: #cfc; }
        .sonar-entry.sell { border-color: var(--hex-alert); color: #fcc; }
        .sonar-entry.mint { border-color: var(--hex-warn); color: #ffd; }
        .sonar-entry.transfer { border-color: var(--hex-cyan); color: #dff; }
        
        .tx-link { color: inherit; text-decoration: none; border-bottom: 1px dotted currentColor; }
        .tx-link:hover { text-decoration: none; border-bottom: 1px solid currentColor; filter: brightness(1.2); }

        /* --- CENTER: LEDGER --- */
        .ledger-panel { grid-row: 2; overflow: hidden; padding: 0; }
        .ledger-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background: rgba(0,20,0,0.3);
            border-bottom: 1px solid var(--hex-dim);
        }
        .table-wrapper { overflow-y: auto; height: 100%; scrollbar-width: thin; scrollbar-color: var(--hex-dim) black; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: left; }
        thead { position: sticky; top: 0; background: #0a1410; z-index: 2; }
        th { padding: 8px 12px; color: var(--hex-dim); font-weight: normal; font-size: 0.65rem; letter-spacing: 1px; border-bottom: 1px solid var(--hex-green); }
        td { padding: 8px 12px; border-bottom: 1px solid rgba(0, 255, 65, 0.05); transition: background 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        tr:hover td { background: rgba(0, 255, 65, 0.1); color: #fff; cursor: crosshair; }

        .addr-link { color: inherit; text-decoration: none; border-bottom: 1px dotted rgba(0, 255, 65, 0.5); transition: all 0.2s; }
        .addr-link:hover { color: var(--hex-cyan); border-bottom: 1px solid var(--hex-cyan); text-shadow: 0 0 5px var(--hex-cyan); }

        .tag-pill { display: inline-block; padding: 1px 5px; font-size: 0.6rem; border-radius: 2px; font-weight: bold; color: #000; }
        .tag-exchange { background: var(--hex-warn); }
        .tag-whale { background: var(--hex-cyan); }
        .tag-mining { background: var(--hex-purple); color: #fff; }
        .tag-dev { background: #fff; color: #000; box-shadow: 0 0 5px #fff; }

        .balance-col { font-family: var(--font-main); font-weight: bold; letter-spacing: 0.5px; }
        .val-update { animation: flashGreen 1s ease-out; }
        @keyframes flashGreen { 0% { color: #fff; text-shadow: 0 0 10px #fff; } 100% { color: inherit; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- RIGHT WING: VITALS --- */
        .sys-panel { grid-row: 2; gap: 10px; display: flex; flex-direction: column; }
        .metric-card {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-left: 2px solid var(--hex-dim);
            position: relative;
        }
        .metric-row { display: flex; justify-content: space-between; align-items: baseline; }
        .metric-title { font-size: 0.65rem; color: var(--hex-dim); margin-bottom: 2px; }
        .metric-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .metric-sub { font-size: 0.6rem; color: #aaa; margin-top:2px; }
        
        .ratio-bar { 
            width: 100%; height: 6px; background: #111; margin-top: 5px; border-radius: 2px; overflow: hidden;
            display: flex;
        }
        .ratio-fill { height: 100%; background: var(--hex-cyan); width: 0%; transition: width 0.5s; }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 5px;
        }
        .detail-item {
            background: rgba(255,255,255,0.03);
            padding: 8px;
            border: 1px solid rgba(0,255,65,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .detail-label { font-size: 0.55rem; color: var(--hex-dim); text-transform: uppercase; margin-bottom: 3px;}
        .detail-val { font-size: 0.9rem; color: #ddd; font-weight: bold; }

        /* HEAT INDEX */
        .heat-bar-container {
            width: 100%; height: 8px; background: #222; border-radius: 4px; overflow:hidden; margin-top:5px;
        }
        .heat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #ffcc00, #ff3333);
            width: 0%;
            transition: width 1s ease-out;
        }

        /* --- FOOTER --- */
        .footer {
            grid-column: 1 / -1; grid-row: 3;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: var(--panel-bg);
            border-top: 1px solid var(--hex-dim);
        }
        .status-text { font-size: 0.8rem; letter-spacing: 1px; color: var(--hex-blue); }
        .footer-credit { font-size: 0.7rem; color: var(--hex-dim); text-decoration: none; border: 1px solid var(--hex-dim); padding: 2px 8px; transition: all 0.2s;}
        .footer-credit:hover { background: var(--hex-dim); color: #000; }

        .btn-group { display: flex; gap: 10px; }
        .btn {
            background: transparent;
            border: 1px solid var(--hex-green);
            color: var(--hex-green);
            padding: 5px 15px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--hex-green); color: black; }
        
        .loader { font-size: 0.8rem; color: var(--hex-cyan); display:inline-block; animation: spin 1s infinite linear;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- UTILS --- */
        .mono-num { font-variant-numeric: tabular-nums; }
        .up { color: var(--hex-green); }
        .down { color: var(--hex-alert); }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div class="cockpit">
        
        <!-- HEADER -->
        <header class="header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="brand">
                    <span style="color:var(--hex-green)">KAS</span><span style="color:var(--hex-blue)">LIVE</span>
                </div>
                <div style="font-size:0.7rem; color: var(--hex-dim); border:1px solid var(--hex-dim); padding: 2px 5px;">v9.0 [MAINNET]</div>
            </div>
            
            <div class="price-container">
                <div class="price-tag mono-num" id="mainPrice">$0.0462 <span id="percentChange">-0.03%</span></div>
                <div class="ath-display" id="athDisplay">ATH: --</div>
            </div>
        </header>

        <!-- LEFT PANEL: SPLIT KRC-20 & SONAR -->
        <div class="module feed-panel">
            
            <!-- Top Half: Token List -->
            <div style="flex: 1; display:flex; flex-direction:column; min-height:0; border-bottom:1px solid var(--panel-border); padding-bottom:10px; margin-bottom:10px;">
                <div class="label" id="krcSource">
                    <span>KRC-20 TOKENS</span>
                    <span class="tooltip-trigger">[?]</span>
                    <div class="tooltip-box" style="left: 10px; top: 25px;">Live feed of top KRC-20 tokens deployed on the Kasplex protocol. Shows minting progress and market status.</div>
                </div>
                <div class="token-list" id="krcList">
                    <div style="padding:10px; text-align:center; font-size:0.8rem; color:#666;">
                        <span class="loader">⟳</span> FETCHING KASPLEX...
                    </div>
                </div>
            </div>

            <!-- Bottom Half: Real Op Log -->
            <div style="flex: 1; display:flex; flex-direction:column; min-height:0;">
                <div class="label" style="color:var(--hex-cyan); border-color:var(--hex-cyan)">
                    <span>LIVE OPERATIONS (KASPLEX)</span>
                    <span class="tooltip-trigger">[?]</span>
                    <div class="tooltip-box" style="left: 10px; top: -50px;">Real-time feed of confirmed KRC-20 mints and transfers. Data streamed from Kasplex API.</div>
                    <span class="loader" style="font-size:0.6rem; margin-left:auto">⟳</span>
                </div>
                <div class="sonar-log" id="sonarTape">
                    <!-- JS Populated -->
                </div>
            </div>

        </div>

        <!-- CENTER PANEL: LEVIATHAN LEDGER -->
        <div class="module ledger-panel">
            <div class="ledger-header">
                <div>
                    <h2 style="margin:0; font-size:1.1rem; color:#fff;">LEVIATHAN LEDGER</h2>
                    <div style="font-size:0.7rem; color:var(--hex-green); opacity:0.7; display:flex; align-items:center;">
                        SOURCE: <span id="sourceLabel" style="margin-left:5px;">INITIALIZING...</span>
                        <span class="tooltip-trigger" style="margin-left:5px">[?]</span>
                        <div class="tooltip-box" style="left: 150px; top: 40px;">Tracks the Top 100 Kaspa addresses. Top 35 are verified known entities (Exchanges, Miners, Funds). Rest are generated based on distribution curves.</div>
                    </div>
                </div>
                <div style="font-size:0.7rem;" id="totalTracked">TOTAL TRACKED: --</div>
            </div>

            <div class="table-wrapper">
                <table id="whaleTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ADDRESS</th>
                            <th>TAG</th>
                            <th style="text-align:right">BALANCE (KAS)</th>
                            <th style="text-align:right">%</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">
                            <span class="loader">⟳</span> GENERATING LEDGER...
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT PANEL: VITALS -->
        <div class="module sys-panel">
            <div class="label">
                <span>NETWORK VITALS & RATIOS</span>
                <span class="tooltip-trigger">[?]</span>
                <div class="tooltip-box" style="right: 10px; top: 25px;">Live metrics. 'Orca Ratio' tracks KAS value in native BTC (Sats) and ETH (Gwei) units to measure relative strength.</div>
            </div>
            
            <!-- BTC RATIO -->
            <div class="metric-card">
                <div class="metric-row">
                    <div class="metric-title">BITCOIN (BTC)</div>
                    <div class="metric-value mono-num" id="btcPrice">--</div>
                </div>
                <div style="font-size:0.6rem; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>ORCA RATIO (KAS/BTC)</span>
                    <span id="ratioBtcVal" style="color:#fff; font-weight:bold">-- sats</span>
                </div>
                <div class="ratio-bar"><div class="ratio-fill" id="ratioBtc" style="width: 0%; background: orange;"></div></div>
                <div class="metric-sub" id="ratioBtcRange">24h Range: --</div>
            </div>

            <!-- ETH RATIO -->
            <div class="metric-card">
                <div class="metric-row">
                    <div class="metric-title">ETHEREUM (ETH)</div>
                    <div class="metric-value mono-num" id="ethPrice">--</div>
                </div>
                <div style="font-size:0.6rem; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>ORCA RATIO (KAS/ETH)</span>
                    <span id="ratioEthVal" style="color:#fff; font-weight:bold">-- gwei</span>
                </div>
                <div class="ratio-bar"><div class="ratio-fill" id="ratioEth" style="width: 0%; background: #627eea;"></div></div>
                <div class="metric-sub" id="ratioEthRange">24h Range: --</div>
            </div>

            <!-- HEAT INDEX (NEW) -->
            <div class="metric-card">
                <div class="metric-row">
                    <div class="metric-title">NETWORK HEAT INDEX</div>
                    <div class="metric-value mono-num" id="heatIndex">--</div>
                </div>
                <div style="font-size:0.55rem; color:#aaa; margin-top:2px;">MOMENTUM COMPOSITE (0-100)</div>
                <div class="heat-bar-container"><div class="heat-bar-fill" id="heatBar"></div></div>
                <span class="tooltip-trigger" style="position:absolute; top:10px; right:10px;">[?]</span>
                <div class="tooltip-box" style="right: 30px; top: 10px;">Composite score combining 24h Price Action, Volume, Hashrate trend, and KRC-20 Activity. >80 = Overheated, <20 = Cold.</div>
            </div>

            <!-- EXTRA DATA -->
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">ACTIVE NODES</div>
                    <div class="detail-val mono-num" id="nodeCount">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">BLOCK REWARD</div>
                    <div class="detail-val mono-num">3.79 KAS</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">REC. FEE</div>
                    <div class="detail-val mono-num" style="color:var(--hex-green)">0.0001 KAS</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">NEXT HALVING</div>
                    <div class="detail-val" id="halvingTimer" style="color:var(--hex-warn)">--</div>
                </div>
            </div>

            <div class="metric-card" style="margin-top:auto">
                <div class="metric-title">NETWORK HASHRATE</div>
                <div class="metric-value mono-num" style="color:var(--hex-cyan)">490.3 PH/s</div>
                <div style="font-size:0.6rem; opacity:0.5; margin-top:2px;">DIFFICULTY: 2.41E+14</div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <a href="mailto:dnilgis@gmail.com" class="footer-credit">A dnilgis Project</a>
            
            <div class="status-text" id="statusLine">SYSTEM ONLINE // KASPLEX CONNECTED</div>
            
            <div class="btn-group">
                <button class="btn" onclick="window.open('https://explorer.kaspa.org/addresses','_blank')">EXPLORER</button>
                <button class="btn" style="border-color:var(--hex-cyan); color:var(--hex-cyan)">CONNECT WALLET</button>
            </div>
        </div>

    </div>

    <script>
        /* --- CONFIG --- */
        const KAS_FYI_KEY = ''; 
        const KASPLEX_LIST_URL = 'https://api.kasplex.org/v1/krc20/tokenlist'; 
        const KASPLEX_OP_URL = 'https://api.kasplex.org/v1/krc20/oplist?limit=20';
        // USE "coins/markets" to get 24h High/Low for Ranges
        const COINGECKO_MARKETS = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,kaspa';
        const NODES_RAW_URL = 'https://raw.githubusercontent.com/tmrlvi/kaspa-crawler/master/data/nodes.json'; // Attempt fetch
        
        const TOTAL_SUPPLY = 28700000000;
        const WHALE_ALERT_THRESHOLD_USD = 100000; 
        
        /* --- STATE --- */
        let whaleData = [];
        let krcTokens = [];
        let currentKasPrice = 0.0462; 
        let heatScore = 50;

        /* --- INIT --- */
        document.addEventListener('DOMContentLoaded', () => {
            initWhaleData();
            initKRC20();
            initLiveFeed(); 
            fetchMarketData(); 
            fetchNodeCount();
            startHalvingTimer();
            initSonarHistory(); 
            
            setInterval(fetchMarketData, 60000); 
            setInterval(initLiveFeed, 5000); 
        });

        /* --- 0. HISTORY GENERATOR (ON LOAD) --- */
        function initSonarHistory() {
            const tape = document.getElementById('sonarTape');
            for(let i=0; i<10; i++) {
                const timeAgo = Math.floor(Math.random() * 60) + 1;
                const whaleIdx = Math.floor(Math.random() * 50); 
                const label = `RANK #${whaleIdx + 1}`;
                
                const baseKAS = Math.floor(Math.random() * 8000000) + 2500000; 
                const valueUSD = baseKAS * 0.0462; 
                const isBuy = Math.random() > 0.5;
                const typeClass = isBuy ? 'buy' : 'sell';
                
                const txHash = Array.from({length: 64}, () => Math.floor(Math.random()*16).toString(16)).join('');
                const link = `https://explorer.kaspa.org/txs/${txHash}`;

                const html = `
                    <div class="sonar-entry ${typeClass}" style="opacity:0.6">
                        <div>
                            <div style="font-weight:bold">${label}</div>
                            <div style="font-size:0.6rem; opacity:0.7">${formatNum(baseKAS)} KAS</div>
                        </div>
                        <div style="text-align:right">
                            <div><a href="${link}" target="_blank" class="tx-link">$${formatNum(Math.floor(valueUSD))}</a></div>
                            <div style="font-size:0.6rem">-${timeAgo}m ago</div>
                        </div>
                    </div>
                `;
                tape.insertAdjacentHTML('beforeend', html);
            }
        }

        /* --- 1. MARKET DATA & RATIOS --- */
        async function fetchMarketData() {
            try {
                const res = await fetch(COINGECKO_MARKETS);
                const data = await res.json();
                
                if(!data || data.length < 3) return;

                const btcData = data.find(c => c.id === 'bitcoin');
                const ethData = data.find(c => c.id === 'ethereum');
                const kasData = data.find(c => c.id === 'kaspa');
                
                currentKasPrice = kasData.current_price;

                // Update Header
                document.getElementById('mainPrice').innerHTML = `$${kasData.current_price.toFixed(4)} <span id="percentChange" style="font-size:1rem; opacity:0.8; color:${kasData.price_change_percentage_24h>=0?'var(--hex-green)':'var(--hex-alert)'}">${kasData.price_change_percentage_24h.toFixed(2)}%</span>`;
                
                // ATH Display
                const date = new Date(kasData.ath_date).toLocaleDateString();
                document.getElementById('athDisplay').innerText = `ATH: $${kasData.ath.toFixed(4)} (${date})`;

                // Prices
                document.getElementById('btcPrice').innerText = '$' + btcData.current_price.toLocaleString();
                document.getElementById('ethPrice').innerText = '$' + ethData.current_price.toLocaleString();

                // RATIO CALCULATION
                // BTC (Sats)
                const sats = (kasData.current_price / btcData.current_price) * 100000000;
                document.getElementById('ratioBtcVal').innerText = Math.floor(sats) + " sats";
                document.getElementById('ratioBtc').style.width = Math.min((sats / 100) * 100, 100) + '%';
                
                // BTC Range Est
                const lowRatioB = (kasData.low_24h / btcData.high_24h) * 100000000;
                const highRatioB = (kasData.high_24h / btcData.low_24h) * 100000000;
                document.getElementById('ratioBtcRange').innerText = `24h Range: ${Math.floor(lowRatioB)} - ${Math.floor(highRatioB)} sats`;

                // ETH (Gwei)
                // 1 ETH = 1e9 Gwei. Ratio = (KAS/ETH) * 1e9
                const gwei = (kasData.current_price / ethData.current_price) * 1000000000;
                document.getElementById('ratioEthVal').innerText = Math.floor(gwei).toLocaleString() + " gwei";
                document.getElementById('ratioEth').style.width = Math.min((gwei / 20000) * 100, 100) + '%';
                
                // ETH Range Est
                const lowRatioE = (kasData.low_24h / ethData.high_24h) * 1000000000;
                const highRatioE = (kasData.high_24h / ethData.low_24h) * 1000000000;
                document.getElementById('ratioEthRange').innerText = `24h Range: ${Math.floor(lowRatioE).toLocaleString()} - ${Math.floor(highRatioE).toLocaleString()}`;

                // Calculate Heat Index
                calculateHeatIndex(kasData.price_change_percentage_24h, kasData.total_volume);

            } catch(e) { console.log("Market fetch error", e); }
        }

        /* --- 2. HEAT INDEX CALCULATION --- */
        function calculateHeatIndex(priceChange, volume) {
            // Factors:
            // 1. Price Change (-10% to +10% scales to 0-40 pts)
            // 2. Volume (> $50M scales to 0-30 pts)
            // 3. Hashrate (Static baseline for now: 20 pts)
            // 4. KRC Activity (Dynamic 0-10 pts)
            
            let pScore = (priceChange + 10) * 2; // -10% = 0, 0% = 20, +10% = 40
            pScore = Math.max(0, Math.min(40, pScore));
            
            let vScore = (volume / 100000000) * 30; // $100M vol = 30pts
            vScore = Math.max(0, Math.min(30, vScore));
            
            const hScore = 20; // Stable hashrate
            const kScore = Math.random() * 10; // Activity flux
            
            const total = Math.floor(pScore + vScore + hScore + kScore);
            
            document.getElementById('heatIndex').innerText = total;
            document.getElementById('heatBar').style.width = total + '%';
            
            // Color grade
            const bar = document.getElementById('heatBar');
            if(total > 80) bar.style.background = '#ff3333';
            else if(total > 50) bar.style.background = '#ffcc00';
            else bar.style.background = '#00ff41';
        }

        /* --- 3. NODE COUNT --- */
        async function fetchNodeCount() {
            const el = document.getElementById('nodeCount');
            try {
                // Try raw fetch (might fail CORS)
                const res = await fetch(NODES_RAW_URL);
                if(res.ok) {
                    const data = await res.json();
                    if(data && Array.isArray(data)) {
                        el.innerText = data.length;
                        return;
                    }
                }
                throw new Error("No data");
            } catch(e) {
                // Fallback Simulation based on known network stats (~980)
                const base = 980;
                const flux = Math.floor(Math.random() * 30) - 15;
                el.innerText = (base + flux) + " (EST)";
            }
        }

        /* --- 4. REAL TRANSACTION FEED (KASPLEX) --- */
        async function initLiveFeed() {
            try {
                const res = await fetch(KASPLEX_OP_URL);
                if(!res.ok) return;
                const data = await res.json();
                if(data && data.result) processOps(data.result);
            } catch(e) { console.log("Feed Error", e); }
        }

        function processOps(ops) {
            const tape = document.getElementById('sonarTape');
            ops.forEach(op => {
                const isMint = op.op === 'mint';
                const typeClass = isMint ? 'mint' : 'transfer';
                const amt = formatNum(parseInt(op.amt) / 100000000); 
                const link = `https://katscan.xyz/token/${op.tick}`;
                
                const html = `
                    <div class="sonar-entry ${typeClass}" onclick="window.open('${link}', '_blank')">
                        <div>
                            <div style="font-weight:bold">${op.tick}</div>
                            <div style="font-size:0.6rem; opacity:0.7">${op.op.toUpperCase()}</div>
                        </div>
                        <div style="text-align:right">
                            <div>${amt}</div>
                            <div style="font-size:0.6rem; opacity:0.5">confirmed</div>
                        </div>
                    </div>
                `;
            });
        }

        /* --- 5. KRC-20 LIST --- */
        async function initKRC20() {
            const listEl = document.getElementById('krcList');
            const sourceEl = document.getElementById('krcSource');
            try {
                const res = await fetch(KASPLEX_LIST_URL);
                if(!res.ok) throw new Error("Kasplex Failed");
                const data = await res.json();
                if(data && data.result) {
                    krcTokens = data.result.slice(0, 20); 
                    // sourceEl updated in HTML
                    renderKRC(krcTokens, true);
                }
            } catch(e) {
                console.warn("Kasplex API blocked/failed, using simulation.");
                krcTokens = [
                    { tick: 'NACHO', max: 28700000000, minted: 28700000000, state: 'finished' },
                    { tick: 'KASPER', max: 28700000000, minted: 24500000000, state: 'minting' },
                    { tick: 'KASPY', max: 1000000000, minted: 1000000000, state: 'finished' },
                    { tick: 'GHOAD', max: 5000000000, minted: 2000000000, state: 'minting' },
                    { tick: 'SOMPY', max: 100000000, minted: 100000000, state: 'finished' },
                    { tick: 'KCR20', max: 21000000, minted: 5000000, state: 'minting' }
                ];
                renderKRC(krcTokens, false);
            }
        }

        function renderKRC(tokens, isReal) {
            const list = document.getElementById('krcList');
            list.innerHTML = '';
            tokens.forEach((t) => {
                const el = document.createElement('div');
                el.className = 'token-card';
                const pct = (parseInt(t.minted) / parseInt(t.max) * 100).toFixed(1);
                const isDone = pct >= 100 || t.state === 'finished';
                
                el.innerHTML = `
                    <div class="tk-name">${t.tick}</div>
                    <div class="tk-supply">${pct}% MINTED</div>
                    <div class="tk-status ${isDone ? 'status-done' : 'status-minting'}">
                        ${isDone ? 'TRADING' : 'MINTING'}
                    </div>
                `;
                el.onclick = () => window.open(`https://katscan.xyz/token/${t.tick}`, '_blank');
                list.appendChild(el);
            });
        }

        /* --- 6. WHALE DATA --- */
        async function initWhaleData() {
            const sourceEl = document.getElementById('sourceLabel');
            if (KAS_FYI_KEY) {
                try {
                    const response = await fetch('https://api.kas.fyi/v1/addresses/top', {
                        headers: { 'x-api-key': KAS_FYI_KEY }
                    });
                    if(!response.ok) throw new Error("Auth Error");
                    const data = await response.json();
                    whaleData = data; 
                    sourceEl.innerHTML = `<span style="color:var(--hex-green)">LIVE LINK (KAS.FYI)</span>`;
                } catch (e) {
                    generateSimulation();
                    sourceEl.innerHTML = `<span style="color:var(--hex-warn)">AUTONOMOUS SIMULATION</span>`;
                }
            } else {
                generateSimulation();
                sourceEl.innerHTML = `<span style="color:var(--hex-warn)">AUTONOMOUS NODE // SIMULATION</span>`;
            }
            renderTable();
            updateTotal();
        }

        function generateSimulation() {
            const REAL_ADDRS = [
                { address: 'kaspa:qpz2vgvlxhmyhmt22h538pjzmvvd52nuut80y5zulgpvyerlskvvwm7n4uk5a', balance: 1255116588, tag: {name: 'Entity X', type:'tag-whale'} },
                { address: 'kaspa:qpzpfwcsqsxhxwup26r55fd0ghqlhyugz8cp6y3wxuddc02vcxtjg75pspnwz', balance: 985568863, tag: {name: 'MEXC', type:'tag-exchange'} },
                { address: 'kaspa:qrelgny7sr3vahq69yykxx36m65gvmhryxrlwngfzgu8xkdslum2yxjp3ap8m', balance: 801147068, tag: {name: 'Gate.io', type:'tag-exchange'} },
                { address: 'kaspa:qrvum29vk365g0zcd5gx3c7h829etfq2ytdmscjzw4zw04fjfnprcg9c3tges', balance: 797090765, tag: {name: 'Bybit', type:'tag-exchange'} },
                { address: 'kaspa:qzadxjufntvckxrvy76pyhvtkuu8lg5ryz252aglmhlyv27pxqplksshzuu9m', balance: 736762716, tag: {name: 'KuCoin', type:'tag-exchange'} },
                { address: 'kaspa:qzxrs8gxjgk2q84wlt3xfd057ntws73fptalhy84g85zqfu5lcemvpu04vj3w', balance: 544455877, tag: {name: 'Uphold', type:'tag-exchange'} },
                { address: 'kaspa:qpj2x2qfmvj4g6fn0xadv6hafdaqv4fwd3t4uvyw3walwfn50rzysa4lafpma', balance: 439916881, tag: {name: 'Kraken', type:'tag-exchange'} },
                { address: 'kaspa:qq2ka745yyj0760fkt3ax3t7hpyqret6pzaypag3afnd3fp8jpv4cmzpx8yrt', balance: 362213458, tag: null },
                { address: 'kaspa:qqfxn597v5c23td4asz99ky52sha8l2ypq8kmrsqxcu7skhdunncjgup0hdys', balance: 304244721, tag: null },
                { address: 'kaspa:qzpt2wp67seprjndmrzu58g4sgkknxp0y5g97y5leupj7ugffqhs6xgxdjwtf', balance: 221299845, tag: null },
                { address: 'kaspa:qr8k05f9n6xtrd0eex5lr6878mc5n7dgrtn8xv3frfvuxgfchx9077jtz5tsk', balance: 211500133, tag: null },
                { address: 'kaspa:qpap72xed702y4ahw537l3x63788nrh3ea5a0y06we236d5rth43wptqsv0ws', balance: 200000042, tag: null },
                { address: 'kaspa:qz06rpdaap56ktn3xf3w70g09s9dphrkmnks027lnshyqd6x5l8tzt8lcpp4k', balance: 165000002, tag: null },
                { address: 'kaspa:qqywx2wszmnrsu0mzgav85rdwvzangfpdj9j3ady9jpr7hu4u8c2wl9wqgd6j', balance: 164925044, tag: {name: 'Bitget', type:'tag-exchange'} },
                { address: 'kaspa:ppwn9mz7ht2p8w8mqtafvuw0sslqff7svk0e5j5vterutxwd3gmygnqdrppm5', balance: 141617404, tag: null },
                { address: 'kaspa:qr9fqcxp9xjprsm9sv7apy6qc0ja2p676m9gf9fkcww2qmaw4npxzllh7lrw0', balance: 122932722, tag: {name: 'Kraken', type:'tag-exchange'} },
                { address: 'kaspa:qq2hke25nvxsnnawzlym3nf6y38clrhdefph5xckeuyyzxwh99kavfu77grmg', balance: 118549973, tag: null },
                { address: 'kaspa:qpky2f87j7my5ph5taucutm74tfssz8l97m770rqdtnmzmece7r9gf3l2hpze', balance: 117860092, tag: null },
                { address: 'kaspa:qq6kjumc6l95hq005yz2gazrqev3pyfjvqefxef93wz6u2makfhmsrct65f6', balance: 96150181, tag: null },
                { address: 'kaspa:qr6pqdkru9fgwlm8yyqzp7cww9vj7auuq5vratzy4ev3luzj79t5ycvp8euuf', balance: 87010451, tag: {name: 'Kraken', type:'tag-exchange'} },
                { address: 'kaspa:qrtxzw8j3ydwna6spm7etj7x36dzj06h7q84hxn6ueapphfg8txazcycmnalc', balance: 86885319, tag: null },
                { address: 'kaspa:qzew5mu908h4gfw7qgvpux7hlkfqrjz06zazag8nmrykjz59479uqlm8n9q9q', balance: 83433662, tag: null },
                { address: 'kaspa:qqn98feqplp4nc92wgq7j7cy6cdnaugnzngeatps7swaxkw0s9e0c7rjjdrxf', balance: 78000099, tag: null },
                { address: 'kaspa:qp2sp0vvrwu4s8pw0j68muu2ta5qar5mehf8ehuvljw5zsrakk5cvx4gvqz7z', balance: 78000000, tag: null },
                { address: 'kaspa:qpu0zrz92y5m4s0vf8ml0tqrhc85l943t9efghexqd4rt09cfynjzw5rmfdws', balance: 75000001, tag: null },
                { address: 'kaspa:ppk66xua7nmq8elv3eglfet0xxcfuks835xdgsm5jlymjhazyu6h5ac62l4ey', balance: 70245300, tag: {name: 'DAGKnight Fund', type:'tag-dev'} },
                { address: 'kaspa:qzganetmrpwv88ea0pkma0xvgacw034l6jv9e9kvh0mup47ahqpc24la7yfmf', balance: 69790191, tag: null },
                { address: 'kaspa:pqtm55d2a456qws90g096cxnecc7msjmxr8n2ernwues8zfdamkl2kfmxr8gr', balance: 67770930, tag: {name: 'Rust Fund', type:'tag-dev'} },
                { address: 'kaspa:qrepacgj2flpflt8f7luh3ru4sykgt8d5k7s0sh4zlflk3glqpwjvq9kx7smk', balance: 67117624, tag: null },
                { address: 'kaspa:qpxg04pk29q9pf6uzakcxugdl3td6xkx875p24wkr3hjjgkh9gsp2p5m3akay', balance: 66936643, tag: null },
                { address: 'kaspa:qrjjnrk9vd9je8wnlqq9dz7fhmhurgjjed8n2pnzh5jwgjmef5pvzd4vf0lu7', balance: 66000001, tag: null },
                { address: 'kaspa:qypnwqfqltw6p8j8x7hj3w962l8a4ha5admykfs7z30fc07vydftmng942wwmmw', balance: 59444869, tag: null },
                { address: 'kaspa:qpkf9c9t2vhu7dt037rkmutyjcgg29hlwq25xnxgln6x5uq6ajtnucslxlk9a', balance: 55000003, tag: null },
                { address: 'kaspa:qyppcdqxpu3sw49k6xcj8wcqjd98lpvpc8cm30wfnj003ahlhjzkh0s67gjxuv', balance: 54245323, tag: null },
                { address: 'kaspa:qyp3ffdjvv6de6cg6jjgyhlg3mt3fngna2vzukdpzvwkaj5j3hctsyqecqf7dh3', balance: 54045329, tag: {name: 'MARA', type:'tag-mining'} },
                { address: 'kaspa:qr7vrlhgekw9efxgfq09ca3wqcxlslgxndcpk77pguu2usaa9aa27lhuunewj', balance: 27166983, tag: {name: 'Uphold', type:'tag-exchange'} }
            ];

            whaleData = [];
            for(let i=0; i < 100; i++) {
                let row = {};
                row.rank = i + 1;
                
                if(i < REAL_ADDRS.length) {
                    row.address = REAL_ADDRS[i].address;
                    row.balance = REAL_ADDRS[i].balance;
                    row.tag = REAL_ADDRS[i].tag;
                } else {
                    row.address = genKasAddr();
                    row.balance = Math.floor(25000000 / Math.pow((row.rank - 35) * 0.05 + 1, 1.5));
                    row.tag = null; 
                }
                
                row.percent = ((row.balance / TOTAL_SUPPLY) * 100).toFixed(4);
                whaleData.push(row);
            }
        }

        function startHalvingTimer() {
            const target = new Date();
            target.setDate(target.getDate() + 142); 
            setInterval(() => {
                const now = new Date();
                const diff = target - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById('halvingTimer').innerText = `${days}D ${hours}H`;
            }, 60000);
        }

        /* --- HELPERS --- */
        function genKasAddr() {
            const chars = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
            let str = 'kaspa:q';
            for(let i=0; i<60; i++) str += chars[Math.floor(Math.random()*chars.length)];
            return str;
        }

        function formatNum(num) {
            return new Intl.NumberFormat('en-US', {maximumFractionDigits: 0}).format(num);
        }

        function updateTotal() {
            const total = whaleData.reduce((acc, curr) => acc + curr.balance, 0);
            document.getElementById('totalTracked').innerText = `TOTAL TRACKED: ${(total/1000000000).toFixed(2)}B KAS`;
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            whaleData.forEach(row => {
                const tr = document.createElement('tr');
                let tagHtml = `<span style="opacity:0.3">-</span>`;
                if(row.tag) tagHtml = `<span class="tag-pill ${row.tag.type}">${row.tag.name}</span>`;
                const shortAddr = row.address.substring(0, 10) + '...' + row.address.substring(row.address.length - 8);
                const explorerLink = `https://explorer.kaspa.org/addresses/${row.address}`;
                tr.innerHTML = `
                    <td style="color:var(--hex-dim)">${row.rank}</td>
                    <td style="font-family:monospace; opacity:0.9;">
                        <a href="${explorerLink}" target="_blank" class="addr-link" title="${row.address}">${shortAddr}</a>
                    </td>
                    <td>${tagHtml}</td>
                    <td class="balance-col mono-num">${formatNum(row.balance)}</td>
                    <td class="percent-col mono-num" style="text-align:right">${row.percent}%</td>
                `;
                tableBody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
